name: Chat SQL Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Specify the Python version(s) you want to test with
        python-version: [3.8] # You can add more versions like [3.8, 3.9, 3.10]
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          # The following options are often defaults but kept for clarity
          check-latest: false # Set to true if you always want the latest patch version
          token: ${{ secrets.GITHUB_TOKEN }} # Needed for some setup-python features
          update-environment: true # Updates pip/setuptools/wheel
          allow-prereleases: false # Don't use prerelease versions of Python
          cache: 'pip' # Add caching for pip dependencies

      - name: Upgrade pip and install dependencies
        run: |
          python -m pip install --upgrade pip
          # Explicitly install known core dependencies needed by the code and tests
          # This ensures pandas, openai, and pytest are present
          echo "Installing core dependencies: pandas, openai, pytest"
          python -m pip install pandas openai pytest
          
          # Attempt to install dependencies from requirements.txt if it exists
          # This handles any other dependencies listed there
          if [ -f requirements.txt ]; then
            echo "requirements.txt found, installing..."
            python -m pip install -r requirements.txt
          else
            echo "requirements.txt not found, skipping."
          fi
          
          echo "Listing installed packages:"
          python -m pip freeze # List installed packages for debugging

      # The Flake8 linting step has been removed.

      - name: Run tests with pytest in LLM_SQL
        run: |
          # Run pytest:
          # --maxfail=1 : Stop after the first test failure
          # --disable-warnings : Suppress warnings during test execution
          # -q : Run in quiet mode (less verbose output)
          # LLM_SQL/ : Specify the directory containing the tests
          pytest --maxfail=1 --disable-warnings -q LLM_SQL/
